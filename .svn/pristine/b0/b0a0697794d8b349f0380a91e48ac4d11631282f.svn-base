using DexComanda.Models;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Security.Cryptography;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace DexComanda
{
    public partial class frmCadastroUsuario : Form
    {
        private Conexao con;
        private Usuario usuario;
        private Main parentMain;
        int rowIndex;
        int codigo;

        public frmCadastroUsuario()
        {
           // this.parentMain = parent;
           
            InitializeComponent();
        }

        private void frmCadastroUsuario_Load(object sender, EventArgs e)
        {
            con = new Conexao();
            PopularGrid("Usuario", usuariosGridView, "spObterUsuario");
            
        }

        private void AdicionarSalvarUsuario(object sender, EventArgs e)
        {
            if (txtNomeUsuario.Text!="" && txtSenha.Text!="")
            {
                string hashSenha = Utils.EncryptMd5(this.txtNomeUsuario.Text.ToString(), this.txtSenha.Text.ToString());

                Usuario usuario = new Usuario()
                {
                    Nome = txtNomeUsuario.Text,
                    Senha = hashSenha.ToUpper(),
                    AlteraProdutosSN = chkAlteraProdutos.Checked,
                    CancelaPedidosSN = chkCancelaPedidos.Checked,
                    AdministradorSN = chkAdministrador.Checked,
                    AcessaRelatoriosSN = chkAcessaRelat.Checked,
                    FinalizaPedidoSN = chkFechaPedido.Checked
                };


                con.Insert("spAdicionarUsuario", usuario);
                MessageBox.Show("Usuario cadastrado com sucesso");
                PopularGrid("Usuario", usuariosGridView, "spObterUsuario");
            }
            else
            {
                MessageBox.Show("Preecha corretamente os campos para continuar");

            }
           
          //  this_FormClosing();
        }
        private void this_FormClosing()
        {
            this.parentMain.PopularGrid(false,"Usuario", usuariosGridView, "spObterUsuario");
            this.Dispose();
        }
        public void PopularGrid(string table, DataGridView gridView, string spName)
        {
            gridView.DataSource = null;
            gridView.AutoGenerateColumns = true;
            gridView.DataSource = con.SelectAll(table, spName);
            gridView.DataMember = table;
            con.Close();
        }

        private void Editar(object sender, EventArgs e)
        {
            if (usuariosGridView.SelectedRows.Count > 0)
            {
                codigo = int.Parse(this.usuariosGridView.SelectedRows[rowIndex].Cells[0].Value.ToString());
                string nome = this.usuariosGridView.SelectedRows[rowIndex].Cells[1].Value.ToString();
                Usuario user = new Usuario()
                {
                    Codigo = codigo,
                    Nome = nome,
                    CancelaPedidosSN = chkCancelaPedidos.Checked,
                    AlteraProdutosSN = chkAlteraProdutos.Checked,
                    AdministradorSN = chkAdministrador.Checked,
                    AcessaRelatoriosSN = chkAcessaRelat.Checked,
                    FinalizaPedidoSN = chkFechaPedido.Checked
                };

                con.Update("spAlterarUsuario", user);
            }
            else
            {
                MessageBox.Show("Selecione um registro para editar", "Dex Aviso");
            }
        }
    }
}
