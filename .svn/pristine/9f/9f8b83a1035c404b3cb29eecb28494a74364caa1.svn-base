using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Data.SqlClient;
using DexComanda.Models;

namespace DexComanda
{
    public partial class frmCadastroCliente : Form
    {
        private Conexao con;
        private Main parentMain;
        private Pessoa cliente;
        private int codigoClienteParaAlterar;
        private string CidadePadrao;
        private string EstadoPadrao;


        public frmCadastroCliente(Main parent)
        {
            InitializeComponent();
            this.parentMain = parent;
            // ObterCidadePadrao();
            //ObterCidadePadrao();
        }

        public frmCadastroCliente(Pessoa cli, Main parent)
        {
            InitializeComponent();
            this.parentMain = parent;
            this.cliente = cli;
            txtDataNascimento.Text = cli.DataNascimento.ToString();
            txtNomeCliente.Focus();
            txtNomeCliente.Select();
            //ObterCidadePadrao();
            // ObterCidadePadrao();
        }

        private void btSalvar_Click(object sender, EventArgs e)
        {

        }

        private void frmCadastroCliente_Load(object sender, EventArgs e)
        {
            
            con = new Conexao();
            dtFim.Value = dtInicio.Value = DateTime.Now;
            txtNomeCliente.Focus();
            txtNomeCliente.Select();
            ObterCidadePadrao();
            if (Sessions.returnConfig != null)
            {
                lblDataNascimento.Visible = txtDataNascimento.Visible = Sessions.returnConfig.UsaDataNascimento;
                lblTelefone2.Visible = txtTelefone2.Visible = Sessions.returnConfig.Usa2Telefones;
            }
            if (cliente != null)
            {
                if (Sessions.returnConfig != null)
                {
                    if (Sessions.returnConfig.UsaDataNascimento)
                    {
                        this.txtDataNascimento.Enabled = true;
                        // this.txtDataNascimento.BackColor = Color.LightGray;
                    }
                    else
                    {
                        this.txtDataNascimento.Enabled = false;
                    }

                }

                this.btnAdicionarCliente.Text = "Alterar";
                this.btnAdicionarCliente.Click -= AdicionarCliente;
                this.btnAdicionarCliente.Click += AlterarCliente;

                codigoClienteParaAlterar = cliente.Codigo;
                DataSet pessoa = con.SelectPessoaPorCodigo("Pessoa", "spObterPessoaPorCodigo", codigoClienteParaAlterar);
                if (pessoa.Tables["Pessoa"].Rows.Count > 0)
                {
                    DataRow dRow = pessoa.Tables["Pessoa"].Rows[0];

                    this.txtNomeCliente.Text = dRow.ItemArray.GetValue(1).ToString();
                    this.txtCEP.Text = dRow.ItemArray.GetValue(2).ToString();
                    this.txtEndereco.Text = dRow.ItemArray.GetValue(3).ToString();
                    this.txtBairro.Text = dRow.ItemArray.GetValue(4).ToString();
                    this.txtCidade.Text = dRow.ItemArray.GetValue(5).ToString();
                    this.txtEstado.Text = dRow.ItemArray.GetValue(6).ToString();
                    this.txtPontoReferencia.Text = dRow.ItemArray.GetValue(7).ToString();
                    this.txtObservacaoCliente.Text = dRow.ItemArray.GetValue(8).ToString();
                    this.txtNumero.Text = dRow.ItemArray.GetValue(9).ToString();
                    this.txtTelefone.Text = Convert.ToString(dRow.ItemArray.GetValue(10).ToString());
                    if (txtTelefone2.Visible == true)
                    {
                        txtTelefone2.Text = dRow.ItemArray.GetValue(11).ToString();
                    }
                }

            }
        }

        private void ConsultarEnderecoPorCep(object sender, KeyEventArgs e)
        {

            if (txtCEP.Text.Length == 8)
            {
                ObterCidadePadrao();
                if (this.txtCEP.Text.Equals(""))
                {
                    MessageBox.Show("Informe o Cep.");
                }
                else
                {

                    int cep = int.Parse(this.txtCEP.Text);
                    DataSet endereco = con.SelectEnderecoPorCep("base_cep", "spObterEnderecoPorCep", cep);

                    if (endereco.Tables["base_cep"].Rows.Count > 0)
                    {
                        // ObterCidadePadrao();
                        DataRow dRow = endereco.Tables["base_cep"].Rows[0];

                        this.txtEndereco.Text = dRow.ItemArray.GetValue(0).ToString();
                        this.txtBairro.Text = dRow.ItemArray.GetValue(1).ToString();
                        //  this.txtCidade.Text = CidadePadrao;//dRow.ItemArray.GetValue(2).ToString();
                        //this.txtEstado.Text = EstadoPadrao;//dRow.ItemArray.GetValue(3).ToString();
                        this.txtNumero.Focus();
                    }
                    else
                    {
                        // ObterCidadePadrao();
                        MessageBox.Show("Cep não encontrado");

                        this.txtEndereco.Focus();
                    }
                }
            }

        }

        private void AdicionarCliente(object sender, EventArgs e)
        {
            try
            {
                string _cep = "0";
                if (this.txtCEP.Text.ToString() != "")
                {
                    _cep = this.txtCEP.Text;
                }
                else
                {
                    _cep = "290";
                }

                Pessoa pessoa = new Pessoa()
                {
                    Nome = this.txtNomeCliente.Text,
                    Endereco = this.txtEndereco.Text,
                    Bairro = this.txtBairro.Text,
                    Cidade = this.txtCidade.Text,
                    Cep = _cep,
                    PontoReferencia = this.txtPontoReferencia.Text,
                    Observacao = this.txtObservacaoCliente.Text,
                    Telefone = this.txtTelefone.Text,
                    UF = this.txtEstado.Text,
                    TicketFidelidade = 0

                };
                if (txtDataNascimento.Visible == true)
                {
                    //pessoa.DataNascimento = Convert.ToDateTime(txtDataNascimento.Text);
                    pessoa.DataNascimento = Convert.ToDateTime(txtDataNascimento.Text + " " + "23:58:00");
                }
                else
                {
                    pessoa.DataNascimento = Convert.ToDateTime("01/01/1950" + " " + "23:58:00");
                }

                if (txtNumero.Text != "")
                {
                    pessoa.Numero = txtNumero.Text;
                }
                else
                {
                    MessageBox.Show("Numero não pode ser vazio");
                    txtNumero.Focus();
                }
                if (txtTelefone2.Visible == true)
                {
                    if (txtTelefone2.Text == "")
                    {
                        MessageBox.Show("Telefone não pode ser vazio");
                        txtTelefone2.Focus();
                    }
                    else
                    {
                        pessoa.Telefone2 = txtTelefone2.Text;
                    }

                }
                else
                {
                    pessoa.Telefone2 = "0";
                }

                con.Insert("spAdicionarClienteDelivery", pessoa);
                MessageBox.Show("Cliente cadastrado com sucesso.");
                this_FormClosing();
                RealizarPedidoAgora(pessoa.Telefone);
            }
            catch (Exception err)
            {
                MessageBox.Show("Registro não foi gravado , favor verificar os campos digitados " + err.Message);
            }

        }

        private void RealizarPedidoAgora(string telefone)
        {
            try
            {
                DialogResult resultado = MessageBox.Show("Deseja realizar um Pedido para pessoa cadastrada?", "Aviso", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (resultado == DialogResult.Yes)
                {
                    DBExpertDataSet dbExpert = new DBExpertDataSet();
                    DataSet pessoaTelefone = con.SelectPessoaPorTelefone("Pessoa", "spObterPessoaPorTelefone", telefone);
                    if ((pessoaTelefone.Tables["Pessoa"].Rows.Count == 0))
                    {

                    }
                    else
                    {
                        DataSet Pessoa = con.SelectPessoaPorTelefone("Pessoa", "spObterPessoaPorTelefone", telefone);
                        DataRow dRow = Pessoa.Tables["Pessoa"].Rows[0];

                        this.parentMain.txtNome.Text = dRow.ItemArray.GetValue(1).ToString();
                        this.parentMain.txtEndereco.Text = dRow.ItemArray.GetValue(2).ToString();
                        this.parentMain.txtBairro.Text = dRow.ItemArray.GetValue(3).ToString();
                        this.parentMain.txtCidade.Text = dRow.ItemArray.GetValue(4).ToString();
                        this.parentMain.txtPontoReferencia.Text = dRow.ItemArray.GetValue(5).ToString();

                        frmCadastrarPedido frmCadastrarPedido = new frmCadastrarPedido(DateTime.Now, 0, int.Parse(dRow.ItemArray.GetValue(0).ToString()), "", "", "", "", this.parentMain);
                        frmCadastrarPedido.ShowDialog();
                    }
                }
            }
            catch (Exception tr)
            {

                MessageBox.Show(tr.Message, "DexCommanda");
            }
        }

        private void AlterarCliente(object sender, EventArgs e)
        {
            try
            {
                //int _cep = int.Parse(this.txtCEP.Text);
                string _cep = "0";
                if (this.txtCEP.Text.ToString() != "")
                {
                    _cep = this.txtCEP.Text.ToString();
                }
                else
                {
                    _cep = "29000000";
                }

                Pessoa pessoa = new Pessoa()
                {
                    Codigo = codigoClienteParaAlterar,
                    Nome = this.txtNomeCliente.Text,
                    Endereco = this.txtEndereco.Text,
                    Numero = this.txtNumero.Text,
                    Bairro = this.txtBairro.Text,
                    Cidade = this.txtCidade.Text,
                    Cep = _cep,
                    PontoReferencia = this.txtPontoReferencia.Text,
                    Observacao = this.txtObservacaoCliente.Text,
                    Telefone = this.txtTelefone.Text,
                    UF = this.txtEstado.Text,
                    TicketFidelidade = 0
                };
                if (txtTelefone2.Visible == true)
                {
                    pessoa.Telefone2 = txtTelefone2.Text;
                }
                else
                {
                    pessoa.Telefone2 = "";
                }
                if (txtDataNascimento.Visible == true && txtDataNascimento.Text != "")
                {
                    pessoa.DataNascimento = Convert.ToDateTime(txtDataNascimento.Text + " " + "23:58:00");
                }
                else
                {
                    pessoa.DataNascimento = Convert.ToDateTime("01/01/1950" + " " + "23:58:00");
                }

                con.Update("spAlterarPessoa", pessoa);
                MessageBox.Show("Cliente alterado com sucesso.");

                this_FormClosing();
                //ClearForm(this);
            }
            catch (Exception ex)
            {

                MessageBox.Show("Registro não foi gravado , favor verificar " + ex.Message);
            }
        }

        private void this_FormClosing()
        {
            this.parentMain.PopularGrid("Pessoa", this.parentMain.clientesGridView, "spObterPessoas");
            this.Dispose();
        }

        private static void ClearForm(System.Windows.Forms.Control parent)
        {
            foreach (System.Windows.Forms.Control ctrControl in parent.Controls)
            {
                //Loop through all controls 
                if (object.ReferenceEquals(ctrControl.GetType(), typeof(System.Windows.Forms.TextBox)))
                {
                    //Check to see if it's a textbox 
                    ((System.Windows.Forms.TextBox)ctrControl).Text = string.Empty;
                    //If it is then set the text to String.Empty (empty textbox) 
                }
                else if (object.ReferenceEquals(ctrControl.GetType(), typeof(System.Windows.Forms.RichTextBox)))
                {
                    //If its a RichTextBox clear the text
                    ((System.Windows.Forms.RichTextBox)ctrControl).Text = string.Empty;
                }
                else if (object.ReferenceEquals(ctrControl.GetType(), typeof(System.Windows.Forms.ComboBox)))
                {
                    //Next check if it's a dropdown list 
                    ((System.Windows.Forms.ComboBox)ctrControl).SelectedIndex = -1;
                    //If it is then set its SelectedIndex to 0 
                }
                else if (object.ReferenceEquals(ctrControl.GetType(), typeof(System.Windows.Forms.CheckBox)))
                {
                    //Next uncheck all checkboxes
                    ((System.Windows.Forms.CheckBox)ctrControl).Checked = false;
                }
                else if (object.ReferenceEquals(ctrControl.GetType(), typeof(System.Windows.Forms.RadioButton)))
                {
                    //Unselect all RadioButtons
                    ((System.Windows.Forms.RadioButton)ctrControl).Checked = false;
                }
                if (ctrControl.Controls.Count > 0)
                {
                    //Call itself to get all other controls in other containers 
                    ClearForm(ctrControl);
                }
            }
        }

        private void button1_Click(object sender, EventArgs e)
        {
            this.Close();
        }

        private void txtNomeCliente_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                if (txtNomeCliente.Text != "")
                {
                    txtTelefone.Focus();
                }
            }

        }

        private void txtTelefone_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                if (txtTelefone.Text != "" && txtTelefone2.Visible == true)
                {
                    txtTelefone2.Focus();
                }
                else
                {
                    txtCEP.Focus();
                }
            }
        }

        private void txtEndereco_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                if (txtEndereco.Text != "")
                {
                    txtNumero.Focus();
                }
            }
        }

        private void txtNumero_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                if (txtNumero.Text != "")
                {
                    txtBairro.Focus();
                }
            }
        }

        private void txtBairro_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                if (txtBairro.Text != "")
                {
                    txtCidade.Focus();
                }
            }
        }
        private void ObterCidadePadrao()
        {
            try
            {

                //DataRow Linha = Empresa.Tables["Empresa"].Rows[0];
                txtCidade.Text = Sessions.returnEmpresa.Cidade.ToString();
                txtEstado.Text = Sessions.returnEmpresa.UF.ToString();

                //var Empresa = con.SelectAll("Empresa", "spObterEmpresa");
                //if (Empresa != null)
                //{
                //    DataRow Linha = Empresa.Tables["Empresa"].Rows[0];
                //    txtCidade.Text = Linha.ItemArray.GetValue(7).ToString();
                //    txtEstado.Text = Linha.ItemArray.GetValue(10).ToString();
                //}
            }
            catch (Exception Erro)
            {

                MessageBox.Show(Erro.Message);
            }

        }

        private void txtCidade_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                if (txtCidade.Text != "")
                {
                    txtEstado.Focus();
                }
            }
        }

        private void txtEstado_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                if (txtEstado.Text != "")
                {
                    if (txtDataNascimento.Visible == true)
                    {
                        txtDataNascimento.Focus();
                    }
                    else
                    {
                        txtPontoReferencia.Focus();
                    }

                }

            }
        }

        private void txtObservacaoCliente_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                if (txtObservacaoCliente.Text != "")
                {
                    btnAdicionarCliente.Focus();
                }
            }
        }

        private void txtPontoReferencia_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                if (txtPontoReferencia.Text != "")
                {
                    txtObservacaoCliente.Focus();
                }
            }
        }

        private void txtTelefone2_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                txtCEP.Focus();
            }
        }

        private void txtDataNascimento_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                txtPontoReferencia.Focus();
            }
        }

        private void ConsultarPedidos(object sender, EventArgs e)
        {
            this.PedidosGridView.DataSource = null;
            this.PedidosGridView.AutoGenerateColumns = true;
            //  this.PedidosGridView.DataSource = con.   //SelectAll("Pedido", "spObterGrupo");
            this.PedidosGridView.DataMember = "Grupo";
        }

        private void button1_Click_1(object sender, EventArgs e)
        {
            this.Close();
        }

    }
}
